
# Post Service OZON

Сервис для управления постами и комментариями с использованием GraphQL.

## Общая информация

Этот проект реализует систему для создания, чтения и управления постами и комментариями, аналогичную функционалу на таких платформах, как Habr или Reddit.

### Основные возможности

#### Работа с постами:
- Просмотр списка доступных постов.
- Детальный просмотр поста вместе с комментариями.
- Автор поста может запретить оставление комментариев к своему посту.

#### Работа с комментариями:
- Иерархическая структура комментариев с неограниченной глубиной вложенности.
- Ограничение длины комментария до 2000 символов.
- Поддержка пагинации для удобного просмотра комментариев.

## Инструкции по запуску

### Локальный запуск
1. Склонируйте репозиторий:
   ```bash
   git clone <repository_url>
   ```
2. Запустите PostgreSQL:
   ```bash
   make docker.run.db
   ```
3. Выполните миграции:
   ```bash
   make docker.run.migrate
   ```
   Или используйте:
   ```bash
   make migrate.up
   ```
   если у вас установлен [golang-migrate](https://github.com/golang-migrate/migrate).

4. Запуск сервера:
   ```bash
   make local.run
   ```

### Запуск с использованием Docker
1. Склонируйте репозиторий.
2. Поднимите все сервисы:
   ```bash
   make docker.run
   ```
   Миграции базы данных будут выполнены автоматически.

### Запуск тестов
Для выполнения тестов:
```bash
make tests.run
```

### Остановка контейнеров Docker
Для остановки всех контейнеров:
```bash
make docker.down
```

## API

Все GraphQL-схемы находятся в директории [graph](./graph), разделены на два основных домена: посты и комментарии.

Для удобного тестирования вы можете использовать [Postman коллекцию](https://www.postman.com/joint-operations-operator-99149269/workspace/postsservice/collection/664caa79a3e5d6651fb3f6f2?action=share&creator=28284200), в которой описаны все доступные запросы (Queries, Mutations и Subscriptions).

Проект построен на базе библиотеки [gqlgen](https://gqlgen.com/).

## Реализованный функционал

### Queries (Запросы)
- Получение списка постов с поддержкой пагинации (можно указать номер страницы и её размер).
- Детальный просмотр поста с комментариями (поддерживается неограниченная вложенность и пагинация).

Для оптимизации работы с комментариями реализована схема загрузки данных только при необходимости, что помогает избежать проблемы N+1.

### Mutations (Мутации)
- Создание нового поста с возможностью запрета комментариев.
- Добавление комментария к посту, с возможностью ответов на другие комментарии.

Перед созданием комментария проверяется, разрешены ли комментарии к выбранному посту.

### Subscriptions (Подписки)
Поддерживается подписка на новые комментарии к конкретному посту.

Для работы с подписками реализован `CommentObserver`, который управляет добавлением и удалением слушателей, а также передачей новых данных.

В перспективе возможна реализация аутентификации пользователей (например, на основе JWT), чтобы слушатели идентифицировались по ID пользователя и поста.

### Тестирование
Реализованы unit-тесты для ключевых слоёв приложения с использованием [gomock](https://github.com/golang/mock).

Автоматизирован CI-процесс на базе GitHub Actions для проверки работоспособности тестов и сборки проекта при каждом коммите или pull request.

### Работа с хранилищем данных
Сервис поддерживает два типа хранилищ:
- **PostgreSQL** (по умолчанию).
- **In-memory хранилище** (для тестирования).

Для выбора хранилища:
- В файле [.env](./.env) установите `USE_IN_MEMORY=true`.
- Для Docker измените соответствующую переменную в [docker-compose.yml](./docker-compose.yml).

## Примеры GraphQL-запросов

### Создание поста
```graphql
mutation {
  CreatePost(post: {
    name: "Интересный пост"
    content: "Полезный контент"
    author: "Author1"
    commentsAllowed: true
  }) {
    id
    createdAt
    name
    author
    content
  }
}
```

### Получение списка постов
```graphql
query {
  GetAllPosts(page: 1, pageSize: 3) {
    id
    createdAt
    name
    author
    content
  }
}
```

### Детальная информация о посте
```graphql
query {
  GetPostById(id: 1) {
    id
    createdAt
    name
    author
    content
    commentsAllowed
    comments(page: 1, pageSize: 2) {
      id
      createdAt
      author
      content
      post
      replies {
        id
        createdAt
        author
        content
        post
        replyTo
      }
    }
  }
}
```

### Добавление комментария
```graphql
mutation {
  CreateComment(input: {
    author: "User1"
    content: "Отличный пост!"
    post: "1"
  }) {
    id
    createdAt
    author
    content
    post
    replyTo
  }
}
```

### Подписка на комментарии к посту
```graphql
subscription {
  CommentsSubscription(postId: "1") {
    id
    createdAt
    author
    content
    post
    replyTo
  }
}
```
